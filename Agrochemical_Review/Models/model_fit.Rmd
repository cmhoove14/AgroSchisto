---
title: "Model fit"
author: "Chris Hoover"
date: "November 26, 2018"
output: pdf_document
geometry:margin=1cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(deSolve)
require(rootSolve)
require(coda)
require(viridis)
require(tidyverse)

source("initial_parameters.R")
source("model_helper_functions.R")
source("r0_ag_function.R")
source("mod_q.R")
```

This document describes the epidemiological model, data, and fitting procedure used to derive estimates of snail-to-man and man-to-snail transmission parameters for a baseline model used to estimate the effect of agrochemical pollution on schistosomiasis transmission

# Initial model simulations  
## $R_0$ Check  
First estimate $R_0$ from initial parameters then get equilibirum values of state variables for same parameter set
```{r r0_init}
r0.Ag(parameters = init_pars)

ac.start = c(S = 40*area,
             E = 0,
             I = 0,
             W = 2,
             P = 0.1*area)

eq_vals <- runsteady(y = ac.start, func = agrochem_mod, parms = init_pars)$y

eq_vals
```

```{r base_mod}
r0.Base(init_pars)

base.start = c(S = 40*area,
               E = 0,
               I = 0,
               W = 2)

base_eq <- runsteady(y = base.start, func = base_mod, parms = init_pars)$y

base_eq
```


```{r r0_increase}
#Increase transmission parameters to try and get R0 >1
sec_pars <- init_pars
sec_pars["beta"] <- init_pars["beta"]*5
sec_pars["lambda"] <- init_pars["lambda"]*5

r0.Ag(parameters = sec_pars)

sec_vals <- runsteady(y = ac.start, func = agrochem_mod, parms = sec_pars)$y

sec_vals
```

```{r comp_r0_w}
test_pars <- init_pars
test_r0s <- numeric()
test_ws <- numeric()
base_r0s <- numeric()
base_ws <- numeric()

for(i in seq(1, 20, 0.1)){
  test_pars["beta"] <- init_pars["beta"]/i
  test_pars["lambda"] <- init_pars["lambda"]/i

  test_r0s[i*10-9] <- r0.Ag(parameters = test_pars)[3]
  test_ws[i*10-9] <- runsteady(y = ac.start, func = agrochem_mod, parms = test_pars)$y["W"]

  base_r0s[i*10-9] <- r0.Base(parameters = test_pars)
  base_ws[i*10-9] <- runsteady(y = base.start, func = base_mod, parms = test_pars)$y["W"]
  
  print(i*10-9)
}

plot(test_r0s, test_ws, 
     xlab = "R0", ylab = "equilibrium worm burden")

plot(base_r0s, base_ws, 
     xlab = "R0", ylab = "equilibrium worm burden")

```


Something isn't right: despite $R_0$ being less than one, the equilibrium worm burden is >>0 and the euilibrium snail population from running the model is much bigger than the equilibrium estimate from the r0 function

Next run model with same parameters
```{r mod_sim}
ac.start = c(S = 20*area,
             E = 5*area,
             I = 1*area,
             W = 30,
             P = 0.1*area)

#Time to run simulation
ac.time = seq(0, (365*50), 5)

#Run simulation and add a couple estimates
ac.sim = as.data.frame(ode(ac.start, ac.time, agrochem_mod, init_pars))
  ac.sim$N = ac.sim$S + ac.sim$E + ac.sim$I
  ac.eqbm = ac.sim[dim(ac.sim)[1],]
    
ac.sim %>% ggplot(aes(x = time)) +
  theme_bw() +
  geom_line(aes(y = N), size = 1.25, col = 'black') +
  geom_line(aes(y = S), size = 1.25, col = 'green') +
  geom_line(aes(y = E), size = 1.25, col = 'orange') +
  geom_line(aes(y = I), size = 1.25, col = 'red') 

ac.sim %>% ggplot(aes(x = time)) +
  theme_bw() +
  geom_line(aes(y = P), size = 1.25, col = 'blue') 

ac.sim %>% ggplot(aes(x = time)) +
  theme_bw() +
  geom_line(aes(y = W), size = 1.25, col = 'purple') 

```


$R_0$ estimate here is clearly too low, but we can resolve that by fitting to some actual data to temper the transmission parameters

##TODO: Run model simulation with predator free parameter set  

```{r mod_sim}
#Make copy of parameters to use in initial simulations
ac.pars = init_pars
r0.Ag(parameters = ac.pars)

cvrg = 0.75

ac.pars['cvrg'] = cvrg


#Starting values of state variables
ac.start = c(S = 20*area,
             E = 5*area,
             I = 1*area,
             W = 30,
             P = 0.1*area)

#Time to run simulation
ac.time = seq(0, (365*50), 5)

#Run simulation and add a couple estimates
ac.sim = as.data.frame(ode(ac.start, ac.time, agrochem_mod, ac.pars))
  ac.sim$N = ac.sim$S + ac.sim$E + ac.sim$I
  ac.eqbm = ac.sim[dim(ac.sim)[1],]
    
ac.sim %>% ggplot(aes(x = time)) +
  theme_bw() +
  geom_line(aes(y = N), size = 1.25, col = 'black') +
  geom_line(aes(y = S), size = 1.25, col = 'green') +
  geom_line(aes(y = E), size = 1.25, col = 'orange') +
  geom_line(aes(y = I), size = 1.25, col = 'red') 

ac.sim %>% ggplot(aes(x = time)) +
  theme_bw() +
  geom_line(aes(y = P), size = 1.25, col = 'blue') 

ac.sim %>% ggplot(aes(x = time)) +
  theme_bw() +
  geom_line(aes(y = W), size = 1.25, col = 'purple') 

```
So infection is clearly way to high with those starting parameters. Let's bring in the $R_0$ function and use it to find a resonable starting parameter set.

```{r r0_parameters}
source("r0_of_q.R")

test_betas <- seq(0.1,2,0.05)*init_pars["beta"]
test_lambdas <- seq(0.1,2,0.05)*init_pars["lambda"]

test_pars <- expand.grid(beta = test_betas,
                         lambda = test_lambdas)

test_pars$r0 <- mapply(r0.bl,test_pars$beta, test_pars$lambda)[3,]

#Plot heatmap
test_pars %>%   
  ggplot(aes(x = beta, y = lambda, fill = r0, z = r0)) + 
    geom_tile() +
    geom_contour(breaks = c(1), col = "white") +
    scale_fill_viridis(option = "magma", direction = 1) +
    labs(y = expression(lambda),
         x = expression(beta)) +
    theme_bw() + 
    theme(axis.ticks=element_blank(), 
          axis.text=element_text(size=12), 
          axis.title=element_text(size=14),
          legend.title=element_text(size=15), 
          legend.text=element_text(size=12)) +
    guides(fill=guide_legend(title=expression(R[0]),
                             reverse = T))

```
We'll choose a parameter set with $R_0\sim1.02$ as starting estimates for fitting

```{r update_parameters}
test_pars_r01.01 <- test_pars %>% filter(round(r0, 2) == 1.02)

ac.pars2 <- ac.pars

ac.pars2["beta"] <- test_pars_r01.01$beta[1]
ac.pars2["lambda"] <- test_pars_r01.01$lambda[1]

#Run simulation and add a couple estimates
ac.sim2 = as.data.frame(ode(ac.start, ac.time, agrochem_mod, ac.pars2))
  ac.sim2$N = ac.sim2$S + ac.sim2$E + ac.sim2$I
  ac.sim2$W = (1-cvrg)*ac.sim2$Wu + cvrg*ac.sim2$Wt
  ac.sim2$Wf = ac.sim2$W * sapply(ac.sim2$W, phi_Wk, k=ac.pars2['k']) * 0.5
  
  ac.eqbm2 = ac.sim2[dim(ac.sim2)[1],]
    
ac.sim2 %>% ggplot(aes(x = time)) +
  theme_bw() +
  geom_line(aes(y = N), size = 1.25, col = 'black') +
  geom_line(aes(y = S), size = 1.25, col = 'green') +
  geom_line(aes(y = E), size = 1.25, col = 'orange') +
  geom_line(aes(y = I), size = 1.25, col = 'red') 

ac.sim2 %>% ggplot(aes(x = time)) +
  theme_bw() +
  geom_line(aes(y = P), size = 1.25, col = 'blue') 

ac.sim2 %>% ggplot(aes(x = time)) +
  theme_bw() +
  geom_line(aes(y = W), size = 1.25, col = 'purple') 

```

That's still way too high... Maybe the $R_0$ function is not right? Let's check to see if a transmission parameter set with $R_0<1$ leads to infection.

```{r}
test_pars_r0lt1 <- test_pars %>% filter(round(r0, 2) == 0.95)

ac.pars3 <- ac.pars

ac.pars3["beta"] <- test_pars_r0lt1$beta[1]
ac.pars3["lambda"] <- test_pars_r0lt1$lambda[1]

#Run simulation and add a couple estimates
ac.sim3 = as.data.frame(ode(ac.start, ac.time, agrochem_mod, ac.pars3))
  ac.sim3$N = ac.sim3$S + ac.sim3$E + ac.sim3$I
  ac.sim3$W = (1-cvrg)*ac.sim3$Wu + cvrg*ac.sim3$Wt
  ac.sim3$Wf = ac.sim3$W * sapply(ac.sim3$W, phi_Wk, k=ac.pars3['k']) * 0.5
  
  ac.eqbm2 = ac.sim3[dim(ac.sim3)[1],]
    
ac.sim3 %>% ggplot(aes(x = time)) +
  theme_bw() +
  geom_line(aes(y = N), size = 1.25, col = 'black') +
  geom_line(aes(y = S), size = 1.25, col = 'green') +
  geom_line(aes(y = E), size = 1.25, col = 'orange') +
  geom_line(aes(y = I), size = 1.25, col = 'red') 

ac.sim3 %>% ggplot(aes(x = time)) +
  theme_bw() +
  geom_line(aes(y = P), size = 1.25, col = 'blue') 

ac.sim3 %>% ggplot(aes(x = time)) +
  theme_bw() +
  geom_line(aes(y = W), size = 1.25, col = 'purple') 

```

Yeahhhh so that ain't right.


# Gather epi data to fit to  

# Fit model to epi data  


